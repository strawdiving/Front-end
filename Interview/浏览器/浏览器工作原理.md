## 浏览器进程和线程

## v8引擎，一段js代码如何执行的
**执行上下文，闭包，作用域，作用域链，事件循环**

在执行一段代码时，JS引擎首先会创建一个执行栈。

JS引擎会创建一个全局执行上下文，并push到执行栈中，这个过程JS引擎会为这段代码中所有变量分配内存并赋一个初始值（undefined），创建完成后，JS引擎进入执行阶段，逐行地执行代码，即为之前分配好内存的变量逐个赋值（真实值）

如果这段代码中存在function声明和调用，JS引擎会创建一个函数执行上下文，并push到执行栈中，创建和执行过程同全局执行上下文，但当函数中存在对其他函数的调用时，JS引擎会在父函数执行的过程中，将子函数的全局执行上下文push到执行栈，这也是为什么子函数能访问到父函数内所声明的变量

还有情况，是子函数执行过程中，父函数已经return了，此时子函数会将父函数的上下文从执行栈中移除，同时JS引擎会为还在执行的子函数上下文创建一个闭包，闭包里保存了父函数内声明的变量及其赋值，子函数仍然能在其上下文中访问并使用这些变量/常量。当子函数执行完毕，JS引擎才将子函数的上下文及闭包一并从执行栈中移除。

JS引擎是单线程的，它是如何处理高并发的》即异步调用时是如何执行的？
比如setTimeout或fetch请求都是non-blocking的，异步调用代码触发时，JS引擎会将需要异步执行的代码移出调用栈，直到等待到返回结果，JS引擎会立即将与之对应的回调函数push进任务队列中等待被调用。当执行栈中已经没有需要被执行的代码时，JS引擎会立刻将任务队列中的回调逐个push进调用栈并执行，这个过程称之为事件循环。

Javascript 编译执行
大致流程：
三个阶段：语法分析--》预编译（每个运行环境都会执行一次）--》执行

- 语法分析：--》词法单元--》抽象语法树（AST）--》机器指令

- 预编译：--》运行环境（1.全局，2.函数内部，3.eval ）--》函数调用栈 --》执行上下文（1.创建变量，2.作用域链，3.this指向）

- 执行：--》事件循环：1）宏任务：同步，异步，2）微任务

1. **词法分析**
JS脚本加载完毕后，会首先进入词法分析阶段，首先分析代码块的语法是否正确，不正确则抛出“语法错误”，停止执行。几个步骤：
- 分词，如`var a=2`,分成`var, 2, =, 2`这样的词法单元
- 解析，将词法单元转换成抽象语法树（AST）
- 代码生成，将抽象语法树转换成机器指令

2. **预编译**
JS有三种运行环境：
- 全局环境
- 函数环境
- eval

每进入一个不同的运行环境都会创建一个对应的执行上下文，根据不同的上下文环境，形成一个函数调用栈，栈底永远是全局执行上下文，栈顶永远是当前执行上下文。

- **创建执行上下文**
主要做了三件事：
  - 1. 创建变量对象：参数，函数，变量
  - 2. 建立作用域链：确认当前执行环境是否能访问变量
  - 3. 确定this指向

3. **执行**

   1. 浏览器的构成和运行机制,
   2. 浏览器内核
   3. 浏览器交互: BOM和DOM相关webApi
   4. 事件监听
   5. 浏览器缓存机制
   6. 浏览器的渲染原理
   7. 浏览器的安全性: 攻击

   1.浏览器工作原理
浏览器的主要组件包括： 用户界面－ 包括地址栏、后退/前进按钮、书签目录 浏览器引擎－ 用来查询及操作渲染引擎的接口 渲染引擎－
渲染界面:Firefox、Chrome和Safari是基于两种渲染引擎构建的，Firefox使用Geoko——Mozilla自主研发的渲染引擎，Safari和Chrome都使用webkit.
网络－ 用来完成网络调用，例如http请求 UI 后端－
用来绘制类似组合选择框及对话框等基本组件，具有不特定于某个平台的通用接口，底层使用操作系统的用户接口 JS解释器－ 解释执行JS代码
数据存储－ 属于持久层，浏览器需要在硬盘中保存类似cookie的各种数据

