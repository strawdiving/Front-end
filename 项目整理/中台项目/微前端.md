to B 的发展越来越迅猛，中后台应用需求激增，如何将多项目集合成一个web主体就成为一个问题。

# 什么是微前端
微前端本质是一种项目架构方案，是为了解决前端项目太过庞大，导致项目管理维护难，团队协作乱，升级迭代困难，技术栈不统一等问题，类似微服务的概念，是将微服务扩展到前端开发的一种应用。

如七牛云平台，本质上就是一个微前端应用，左侧菜单是各个子应用的入口，切换菜单的同时就是在切换子应用，而整个主容器就是一个portal门户（可能包含用户登录机制、菜单权限获取、全局异常处理等）

优点：

- 单个前端部分可独立开发、测试和部署
- 无需重新构建即可添加、移除或替换单个前端部分
- 不同的前端部分可使用不同的技术构建

微前端主要实现了解耦，在应用达到一定规模后，微前端就有了用武之地。它支持组织分割为更多团队，乃至创建更小的全栈团队。

适用场景：
- 多个团队贡献同一个前端
- 一些独立的部分需要由特定的用户或团队激活、终止激活或roll out
- 需要支持外部开发人员对UI进行扩展
- UI的特性集每日/周都在增长，并不会影响系统其他部分
- 不论应用如何增长，都需要维持恒定的开发速度
- 支持不同团队使用不同开发工具

# 微前端的落地方式
将微服务的理念应用于浏览器端，即将web应用由单一的单体应用拆分为多个小型前端应用聚集为一体的应用。

# 架构模式
微前端应用间的关系，分为2种：基座模式（管理式），自组织式，分别对应两种不同的架构模式：
- 基座模式。通过一个主应用，来管理其他应用。设计难度小，方便实践，但通用度低。
- 自组织模式。应用间是平等的，不存在相互管理的模式。设计难度大，不方便实施，但通用度高。

两者都需要提供一个查找应用的机制，在微前端中称为**服务的注册表模式**。和微服务架构类似，需要有一个应用注册表的服务，它可以是一个固定值的配置文件，如JSON文件，也可以是一个可动态更新的配置，又或者是一种动态的服务，主要做：
- 应用发现，让主应用可以寻找到其它应用。
- 应用注册，即提供新的微前端应用，向应用注册表注册的功能。
- 第三方应用注册，即让第三方应用，可以接入到系统中
- 访问权限等相关配置

应用在部署的时候，便可以在注册表服务中注册。如果基于注册表来管理应用，则使用基座模式开发比较方便。

# 设计理念
- 中心化：应用注册表。这个表拥有每个应用及对应的入口。入口的直接表现形式可以是路由，或者对应的应用映射
- 标识化应用。需要一个标识符来标识不同的应用，以便于在安装、卸载的时候，能找到指定的应用
- 应用生命周期管理
- 高内聚，低耦合

# 生命周期
前端微架构和后端微架构的最大不同在于————生命周期。微前端作为客户端应用，每个应用拥有自己的生命周期：
- Load，决定加载哪个应用，并绑定生命周期
- bootstrap，获取静态资源
- Mount，安装应用，如创建DOM节点
- Unload，删除应用的生命周期
- Unmount，卸载应用，如删除DOM节点，取消事件绑定

微前端的一个难点，就是如何以合适的方式来加载应用，毕竟每个前端框架都各自不同，其所需要的加载方式也是不同的。

# 如何拆分应用
技术实践上，微前端架构可以采用：
- 前端容器化。将iFrame作为容器，来容纳其它前端应用
- 路由分发式。通过HTTP服务器的反向代理功能，来将请求路由到对应的应用上
- 前端微服务化。在不同的框架之上设计通讯、加载机制，以在一个页面内加载对应的应用
- 微应用。通过软件工程的方式，在部署构建环境中，组合多个独立应用成一个单体应用
- 微件化。开发一个新的构建系统，将部分业务功能构建成一个独立的chunk代码，使用时只需要远程加载即可
- 应用组件化。基于Web Components技术，来构建跨框架的前端应用

依据场景采用不同的架构方式。

## iframe
微前端集成的最简单方式之一。iframe里的页面是完全独立的，而且iframe页面和主页面中的静态资源（js,css)都是相互隔离的，互不干扰，相当于一个独立的环境，具备沙箱隔离，可以让前端应用之间可以互相独立运行。

```html
<iframe v-show='url' frameborder='0' id='contentIframe'></iframe>
createFrame(url) {
  const iframe = document.getElementById('contentIframe')
  const deviceWidth = document.body.clientWidth

  iframe.style.width = `${Number(deviceWidth) - 10 }px`
  iframe.style.height = '800px'
  iframe.src = url
}
```

iframe的局限性：
- 子项目需调整，需要隐藏自身页面中的导航（公共区域）
- iframe嵌入的视图控制难，有局限性
- 刷新无法保持记录，当浏览器刷新状态将消失，后退返回无效
- 阻塞主页面加载

## 路由分发方式
路由分发是指通过路由将不同业务拆分的子项目，结合反向代理的方式实现。

这也是比较简单的一种实现微前端的方式，将多个子项目聚合成一体，可以通过nginx来配置不同路由的转发代理。

```javascript
http {
  server {
    listen 80;
    server_name: 192.168.0.1;
    location /web/monitor {
      proxy_pass http://192.168.0.2/web/monitor;
    }
    location /web/admin {
      proxy_pass http://192.168.0.3/web/admin;
    }
    location / {
      proxy_pass /;
    }
  }
}
```

通过不同的路由请求，转发到不同的项目域名服务器下，这种方式的好处是团队协作方便，框架无关，项目独立部署维护。

局限性：
- web应用之间的复用性差
- 每个独立的项目之间切换，需要重新加载，容易出现白屏影响用户体验

## single-spa
一个用于前端微服务化的JS前端解决方案，能兼容各种技术栈，且在同一个页面中可以使用多种技术框架（vue,react,angular等），不用考虑因新的技术框架而去重构旧项目的代码。

### 原理
容器应用 ———— single-spa.js ———— 子应用

single-spa.js负责：
- 应用注册
- 路由管理
- 应用加载
- 应用卸载

子应用
- bootstrap
- mount
- unmount

首先需要一个主应用（容器应用），需要先注册子应用，然后当url匹配到相应的子应用路由后，将会先请求子应用到资源，然后挂载子应用。同理，当url切换出该子应用路由时，将卸载该应用，以达到切换子应用的效果。通过子应用生命周期bootstrap（获取输出的资源文件）、mount、unmount的交替。

### 优点
- 各项目独立开发、部署、迭代，互不影响效率高
- 开发团队可选择自己的技术并及时更新技术栈
- 相互间的依赖性大大降低
- 有利于CI/CD，更快的交付产品

## qiankun（蚂蚁金服微前端框架）
基于single-spa的微前端实现库，旨在帮助大家能更简单、无痛的构建一个生产可用微前端架构系统。本质上就是在single-spa上做一些封装，使开发者更容易上手。

