# 发送HTTP请求
拿到域名对应的IP地址后，浏览器会以一个随机端口（1024< port < 65535)向服务器的WEB程序（常用的有httpd, nginx等)80端口发起TCP的连接请求。

## TCP连接

1. 应用层：发送 HTTP 请求
在前面的步骤我们已经得到服务器的 IP 地址，浏览器会开始构造一个 HTTP 报文，其中包括：

请求报头（Request Header）：请求方法、目标地址、遵循的协议等等

请求主体（其他参数）

其中需要注意的点：

浏览器只能发送 GET、POST 方法，而打开网页使用的是 GET 方法

2. 传输层：TCP 传输报文
传输层会发起一条到达服务器的 TCP 连接，为了方便传输，会对数据进行分割（以报文段为单位），并标记编号，方便服务器接受时能够准确地还原报文信息。

在建立连接前，会先进行 TCP 三次握手。

### TCP三次握手
(见 three shake.png)
1. 第一次握手：客户端A将标志位SYN置为1，随机产生一个值为seq=J(J的取值范围=1234567)的数据包到服务器，客户端进入 SYN_SENT 状态，等待B端确认；(SYN=1, seq=J,SYN_SENT)
2. 第二次握手：服务端B收到数据包后，由标志位SYN=1知道客户端A请求建立连接，服务端B将标志位 SYN 和 ACK 都置为1，ack=J+1，随机产生一个值 seq = K，并将该数据包发送给客户端A以确认连接请求，服务端进入SYN_RCVD 状态；（ SYN=1，ACK=1，ack=J+1, seq= K, SYN_RCVD ）
3. 第三次握手：客户端A收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给服务端B，服务端检查ack=K+1，ACK是否为1，如果正确则连接建立成功，A和B进入 ESTABLISHED 状态，完成三次握手，然后A和B之间就可以开始传输数据了。 （ ACK=1， ack=K+1, ESTABLISHED )

**为什么需要三次握手**：

为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。

如client发出的第一个连接请求报文段没有丢失，而是在某个网络节点长时间滞留，以致延误到连接释放后的某个时间才到达server，但server收到该失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求，就会向client发出确认报文段，同意建立连接。如果不采用“三次握手”，则只要server发出确认，新连接就建立了。而client并未发出请求，所以不会理睬server的确认，也不会向server发送数据，server以为新连接已经建立，一直等待client的数据，资源就浪费了。

主要目的是为了防止server端一直等待，浪费资源。

### TCP四次挥手
(见 four bye.png)

1. 第一次挥手：Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入 FIN_WAIT_1 状态 （ FIN=M ）
2. 第二次挥手：Server收到FIN，发送一个 ACK 给Client，确认序号为 收到序号+1 （与SYN一样，一个FIN占用一个序号），Server进入 CLOSE_WAIT 状态 （ack = M+1 ）
3. 第三次挥手：Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入 LAST_ACK 状态（ FIN=N ）
4. 第四次挥手：Client收到FIN，Client进入 TIME_WAIT 状态，接着发送一个ACK给Server，确认序号为 收到序号+1， Server进入 CLOSED 状态，完成四次挥手。(ACK =1, ack=K+1 )

**为什么建立连接是三次握手，关闭连接是四次挥手**：

服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放到一个报文里发送给客户端，而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了，但是还能接收数据，己方也未必全部数据都发送给对方了。所以己方可以立即close，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接。因此，己方ACK和FIN一般会分开发送。


相关知识点：SYN 泛洪攻击

3. 网络层：IP协议查询Mac地址
将数据段打包，并加入源及目标的IP地址，并且负责寻找传输路线。

判断目标地址是否与当前地址处于同一网络中，是的话直接根据 Mac 地址发送，否则使用路由表查找下一跳地址，以及使用 ARP 协议查询它的 Mac 地址。

“注意：在 OSI 参考模型中 ARP 协议位于链路层，但在 TCP/IP 中，它位于网络层。”
4. 链路层：以太网协议
以太网协议

根据以太网协议将数据分为以“帧”为单位的数据包，每一帧分为两个部分：

标头：数据包的发送者、接受者、数据类型

数据：数据包具体内容

Mac 地址

以太网规定了连入网络的所有设备都必须具备“网卡”接口，数据包都是从一块网卡传递到另一块网卡，网卡的地址就是 Mac 地址。每一个 Mac 地址都是独一无二的，具备了一对一的能力。

广播

发送数据的方法很原始，直接把数据通过 ARP 协议，向本网络的所有机器发送，接收方根据标头信息与自身 Mac 地址比较，一致就接受，否则丢弃。

注意：接收方回应是单播。

“相关知识点：
ARP 攻击
