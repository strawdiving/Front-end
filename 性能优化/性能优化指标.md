性能优化标准/性能监控平台：Lighthouse
如果没有特殊的定制，大多数都是利用无头浏览器（Puppeteer）跑Lighthouse

Lighthouse

是 Google Chrome 推出的一款开源自动化工具，它可以搜集多个现代网页性能指标，分析 Web 应用的性能并生成报告，为开发人员进行性能优化的提供了参考方向。

一般通过几个指标：

1. FCP(First Content Paint) 首次内容绘制：浏览器首次将任意内容绘制到屏幕上的时间点
2. LCP(Largest Contentful Paint) 最大内容绘制：度量标准报告视口内可见的最大图像或文本块的呈现时间
3. TTI(Time to Interactive) 可交互时间：指所有页面内容都已经成功加载，且能够快速地对用户的操作做出反应的时间点
5. TBT(Total Blocking Time) 总阻塞时间：指FCP与TTI之间的总时间
4. Speed Index 速度指标：衡量了首屏可见内容绘制在屏幕上的速度。在首次加载页面的过程中尽量展现更多内容，往往给用户带来更好的体验，所以值越小越好
6. CLS(Cumulative Layout Shift) 累积布局偏移：页面整个生命周期中，每次元素发生的非预期布局偏移得分的总和。每次可视元素在两次渲染帧中的起始位置不同时，就说是发生了Layout Shift

其中 FCP, LCP, Speed Index 三个指数尤为重要，它们会影响到 TTI, TBT, CLS。

Lighthouse可以找出页面中的常规的性能瓶颈，并提出优化建议。

一些常规的优化：
- 减少未使用的JS
- 移出阻塞渲染的资源
- 图片质量压缩
- 限制使用字体数量，尽可能少用变体
- 优化关键渲染路径：只加载当前页面渲染所需的必要资源，次要资源放在页面渲染完成后加载

1. 改善FCP——优化关键渲染路径
核心：
- 减少初始化视图内容
- 减少初始化下载资源大小

- 初始化用不到的JS文件全部异步加载，defer或async，需要走CDN的第三方插件需要放在页面底部
- js 文件拆包，一般用webpack的splitChunks。有路由的情况下，将路由做拆包处理，保证每个路由只加载当前路由对应的js代码
- 优化文件大小，减少字体包，css,js文件大小，脚手架默认都做了
- 优化项目结构，尽量减少初始化组件的加载数量
- 网络层面的优化，一般在云服务器中开启优化手段，如开启gzip，使用cdn等

2. LCP
为了应对这种潜在的变化，浏览器会在绘制第一帧后立即分发一个largest-contentful-paint类型的`PerformanceEntry`，用于识别最大内容元素。但是，在渲染后续帧之后，浏览器会在最大内容元素发生变化时分发另一个`PerformanceEntry`。

需要注意的是，一个元素只有在渲染完成并且对用户可见后才能被视为最大内容元素。尚未加载的图像不会被视为"渲染完成"。在字体阻塞期使用网页字体的文本节点亦是如此。在这种情况下，较小的元素可能会被报告为最大内容元素，但一旦更大的元素完成渲染，就会通过另一个PerformanceEntry对象进行报告。

通常情况下，图片、视频以及大量文本绘制完成后就会报告LCP

优化手段：尽量减少图片、视频以及大量文本资源的大小即可

- 本地图片使用在线压缩工具压缩：tinypng.com
- 接口中附带图片，一般都有对应的 oss 或 cdn 传参配置通过地址栏传参方式控制图片质量
- 图片懒加载

3. Speed Index
通俗讲，就是衡量页面内容填充的速度。和LCP相同，图片及视频内容对其影响巨大。提高LCP和FCP，Speed Index的事件就会有显著提高

接口的速度也会影响Speed Index的时间。接口速度太慢，也会影响页面的初始渲染，导致性能问题。

常规优化手段：
- 优化图像，优化字体大小
- 利用浏览器缓存机制，启用cdn，gzip等
- 减少网络传输过程中的消耗，减少http请求，减少dns查询，避免重定向
- 优化关键渲染路径，异步加载js等


使用chrome devtool的代码覆盖率，能知道哪些js或css文件代码没有被使用过，结合打包分析工具，看性能瓶颈在哪，再做处理


# Article 2
Lighthouse生成性能分析报告，一个html文件。内容分为5大项,每个打分：
1. Performance：又分为 Metrics(性能指标)，Opportunities（可优化项），Diagnostics(手动诊断)
2. Accessibility：无障碍功能分析，如前景色和背景色有咩有足够对比度，图片有咩有alt属性，a链接有没有可识别名称等
3. Best Practice：最佳实践策略，控制台是否报错，图片纵横比不正确等
4. SEO：有咩有搜索引擎优化的东西
5. Progressive Web App：衡量站点是否快速、可靠和可安装

## Performance
记录了网站运行过程中性能数据。回放整个页面执行过程的话，可以定位和诊断每个时间段内页面运行情况。将采集到的数据按时间线方式展现

Performance -- 勾选Memory，点击Record开始录制，然后执行操作或者刷新页面，点Stop停止录制，生成数据。

分为三大块：
1. 概况页面
FPS，白屏时间，CPU资源消耗，网络加载情况，V8内存使用量（堆）等，按时间顺序展示。
可能存在问题的地方：
- 如果FPS图表上出现红色块，表示红色块附近渲染出一帧的时间太长了，可能导致卡顿
- 如果CPU图形占用面积太大，表示CPU使用率高，可能因为某个JS占用太多主线程时间，阻塞其他任务执行
- 如果V8的内存使用量一直增加，可能存在内存泄漏
    - 一次查看内存占用情况后，看当前Memory内存占用趋势图，走势呈上升趋势，可以认为存在内存泄漏
    - 多次查看内存占用情况后截图对比，比较每次内存占用情况，如果呈上升趋势，也可能存在内存泄漏

通过概览面板定位到可能存在问题的时间节点后，点击时间线上有问题的地方，这一块的详细内容就会显示在下方的性能面板中。

2. 性能面板
点击时间线上某个位置，性能面板会显示该时间节点内的性能数据。
性能指标项包括：
- 最常用：Main 指标：渲染主线程的任务执行记录
一个Task就是一个任务，任务下方会列出这个任务里的子任务。

可以选中标红的Task，看里面具体的耗时点。

比如做了哪些操作，哪些函数耗时了多少，代码压缩的话看到的就是压缩后的函数名。
点击某个函数，面板下面就会出现代码的信息，是那个函数，耗时多少，在哪个文件上的第几行等，就可以定位到耗时函数了。

还可以横向切换 tab ，看它的调用栈等情况，更方便地找到对应代码

- Timings指标：记录FP, FCP, LCP等产生一些关键时间点的数据信息
- Interactions指标：记录用户交互操作
- Network指标：页面每个请求所耗时间
- Compositor指标：合成线程的任务执行记录
- GPU指标：GPU进程的主线程的任务执行记录
- Chrome_ChildIOThread指标：IO线程的任务执行记录，里面由用户输入事件，网络事件，设备相关等事件
- Frames指标：记录每一帧的时间、图层构造等信息

3. Timings指标 —— 关键时间点的数据信息
1. FP (first Paint) 首次绘制：页面第一次绘制像素的时间
1. FCP(First Content Paint) 首次内容绘制：浏览器首次将任意内容绘制到屏幕上的时间点 (只有文本、图片(包括背景图)、非白色的canvas或SVG时才被算作FCP)
2. LCP(Largest Contentful Paint) 最大内容绘制：是代表页面的速度指标,记录视口内可见的最大元素（图像或文本块）的呈现时间，会随着页面渲染变化而变化
3. TTI(Time to Interactive) 可交互时间：首次可交互时间。指所有页面内容都已经成功加载，且能够快速地对用户的操作做出反应的时间点。在视觉上已经渲染了，完全可以响应用户的输入了。是衡量应用加载所需时间并能够快速响应用户交互的指标。与FMP一样，很难规范化适用于所有网页的TTI指标定义
5. TBT(Total Blocking Time) 总阻塞时间：指FCP与TTI之间的总时间，记录FCP到TTI之间所有长任务的阻塞时间总和
4. Speed Index 速度指标：衡量了首屏可见内容绘制在屏幕上的速度。在首次加载页面的过程中尽量展现更多内容，往往给用户带来更好的体验，所以值越小越好
6. CLS(Cumulative Layout Shift) 累积布局偏移：代表页面稳定的指标，页面整个生命周期中，每次元素发生的非预期布局偏移得分的总和。每次可视元素在两次渲染帧中的起始位置不同时，就说是发生了Layout Shift。记录页面非预期的位移，比如渲染过程中插入一张图片或者点击按钮动态插入一段内容等，这时候就会触发位移

FID：首次输入延迟，代表页面交互体验的指标。记录FCP和TTI之间用户首次交互的时间到浏览器实际能够回应这种互动的时间

DCL: 表示HTML加载完成时间
L：表示页面所有资源加载完成时间

注意：DCL和L表示的时间在 Performance 和 NetWork 中是不同的，因为 Performance 的起点是点击录制的时间，Network中起点时间是 fetchStart 时间(检查缓存之前，浏览器准备好使用http请求页面文档的时间)

FMP：首次有意义的绘制。是页面主要内容出现在屏幕上的时间，这是用户感知加载体验的主要指标。有点抽象，因为目前没有标准化的定义。因为很难用通用的方式来确定各种类型的页面的关键内容
FCI：首次CPU空闲时间。表示网页已经满足了最小程度的与用户发生交互行为的时间
FPS：每秒帧率。表示每秒钟画面更新次数，现在大多数设备是60帧/秒

然后根据指标体现出来的问题，有针对性的优化即可
